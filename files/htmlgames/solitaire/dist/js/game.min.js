var BLACK=1;var RED=2;var ANY=3;var ST_SELECTED=3;var ST_UNSELECTED=4;var G_INIT=1;var G_RUNNING=2;var G_STOPPED=3;var G_PAUSED=4;var RULES=[1,2,3,4,5,6,7];var MAX_CARDS=7;var DISPLAY_POSITIONS={pre:{SPRITE_XSTART:47,XSTART:47,XSPACE:55,CARDBACK:{x:377,y:280},BACKSY:{heart:0,diamond:70,club:140,spade:210,misc:280},MAIN_DECK_Y:112,WASTEPOS:{x:47,y:26},ACESPOS:{x:210,space:54},VISIBLE_CARD_SPACE:14,HIDDEN_CARD_SPACE:6,PACK_CARD_SPACE:36},hd:{SPRITE_XSTART:47,XSTART:100,XSPACE:88,CARDBACK:{x:487,y:280},BACKSY:{heart:3,diamond:113,club:223,spade:332,misc:441},MAIN_DECK_Y:280,WASTEPOS:{x:140,y:66},ACESPOS:{x:438,space:120},VISIBLE_CARD_SPACE:18,HIDDEN_CARD_SPACE:6,PACK_CARD_SPACE:36},pixi:{SPRITE_XSTART:47,XSTART:10,XSPACE:55,CARDBACK:{x:377,y:280},BACKSY:{heart:0,diamond:70,club:140,spade:210,misc:280},MAIN_DECK_Y:112,WASTEPOS:{x:10,y:26},ACESPOS:{x:173,space:54},VISIBLE_CARD_SPACE:14,HIDDEN_CARD_SPACE:6,PACK_CARD_SPACE:36},};var SHUFFLE_TRANSLATION=800;var SWAP_TRANSLATION=100;var DBLCLICK_DELAY=270;var DECK_PACK=1;var DECK_ACE_HEART=2;var DECK_ACE_DIAMOND=3;var DECK_ACE_CLUB=4;var DECK_ACE_SPADE=5;var DECK_ACES=6;var DECK_BOTTOM=7;var DECK_WASTE=8;var NUM_CARDS=52;var game={stockPack:new Deck(DECK_PACK),wastePack:new Deck(DECK_WASTE),aceDecks:[],bottomDecks:[],score:0,playAttempts:0,gameStats:{},gameOptions:{},touchMode:true,time:{h:0,m:0,s:0},selectedCard:null,multiSelect:false,cardPos:null,maxDepth:1,statusPanelElt:null,optionsPanelElt:null,timeElt:null,scoreElt:null,stackElt:null,pauseElt:null,scoreEvolElt:null,blockedSelection:false,blockedPack:false,displayPositions:null,init:function(b,a){this.statusPanelElt=jQuery("#statusPanel");this.optionsPanelElt=jQuery("#optionsPanel");this.timeElt=jQuery("#statusPanel").find(".time");this.scoreElt=jQuery("#statusPanel").find(".score");this.stackElt=jQuery('<div class="waste returnedCard visible"/>').appendTo("#playground");this.pauseElt=jQuery("#playground #pause");this.scoreEvolElt=jQuery('<div class="scoreEvol"/>').appendTo("body");this.gameOptions={sound:b.sound,background:b.background,cardset:b.cardset,theme:b.theme,autoFlip:b.autoFlip,autoPlay:b.autoPlay};this.gameStats={status:a.status,date:a.date,gamesTotal:a.gamesTotal,gamesWon:a.gamesWon,scoreTotal:a.scoreTotal};this.displayPositions=DISPLAY_POSITIONS[CM.phoneType];this.wastePosX=this.displayPositions.WASTEPOS.x,this.wastePosY=this.displayPositions.WASTEPOS.y,this.acePosX=this.displayPositions.ACESPOS.x,this.acePosY=this.displayPositions.ACESPOS.y,this.aceSpace=this.displayPositions.ACESPOS.space,this.xSpace=this.displayPositions.XSPACE,this.backYHeart=this.displayPositions.BACKSY.heart,this.backYSpade=this.displayPositions.BACKSY.spade,this.backYDiamond=this.displayPositions.BACKSY.diamond,this.backYSpade=this.displayPositions.BACKSY.spade,this.backYMisc=this.displayPositions.BACKSY.misc,this.backsY=this.displayPositions.BACKSY,this.xStart=this.displayPositions.XSTART,this.visibleCardSpace=this.displayPositions.VISIBLE_CARD_SPACE,this.hiddenCardSpace=this.displayPositions.HIDDEN_CARD_SPACE,this.mainDeckY=this.displayPositions.MAIN_DECK_Y,this.packCardSpace=this.displayPositions.PACK_CARD_SPACE,this.spriteXStart=this.displayPositions.SPRITE_XSTART,this.cardBackX=this.displayPositions.CARDBACK.x,this.cardBackY=this.displayPositions.CARDBACK.y;if(CM.phoneType==="pixi"){jQuery("body").addClass("pixi")}else{if(CM.phoneType==="hd"){jQuery("body").addClass("hd")}}TimerManager.init(jQuery.proxy(this.updateTime,this));this.time={h:0,m:0,s:0};this.setupListeners()},shuffle:function(){var c=new Array(NUM_CARDS);this.stockPack=new Deck(DECK_PACK);this.wastePack=new Deck(DECK_WASTE);this.aceDecks=[new Deck(DECK_ACE_HEART),new Deck(DECK_ACE_DIAMOND),new Deck(DECK_ACE_SPADE),new Deck(DECK_ACE_CLUB)];this.bottomDecks=[new Deck(DECK_BOTTOM,0),new Deck(DECK_BOTTOM,1),new Deck(DECK_BOTTOM,2),new Deck(DECK_BOTTOM,3),new Deck(DECK_BOTTOM,4),new Deck(DECK_BOTTOM,5),new Deck(DECK_BOTTOM,6)];var h=this.bottomDecks,b=this.stockPack;for(var e=0,a=h.length;e<a;e++){h[e].setDeckNum(e)}SoundManager.playSound(SND_SHUFFLE);for(var e=0;e<NUM_CARDS;e++){c[e]=0}for(var e=0;e<NUM_CARDS;e++){var g=Random(NUM_CARDS),d=null;while(c[g]===1){g=Random(NUM_CARDS)}c[g]=1;if(g<27){couleur=BLACK}else{couleur=RED}cardtype="heart";if(g<14){cardtype="spade"}else{if(g<27){cardtype="club"}else{if(g<40){cardtype="diamond"}}}d=new Card(cardtype,g);EventsManager.addDroppable(d);EventsManager.addDraggable(d);b.push(d)}var f=1;while(f<=MAX_CARDS){for(var e=0;e<RULES.length;e++){if(f>RULES[e]){continue}else{var d=b.pop();if(f==RULES[e]){d.setVisible(true);d.enableSelection(true)}h[e].push(d)}}f++}for(var e=0,a=h.length;e<a;e++){h[e].bindTopListeners(DECK_BOTTOM)}for(var e=0,a=this.aceDecks.length;e<a;e++){this.aceDecks[e].bindTopListeners(-1)}this.playAttempts++;this.gameStats.gamesTotal++},resumeGame:function(d){d=d.value;if(this.selectedCard!==null){this.toggleSelectedCard(this.selectedCard)}this.selectedCard=null;this.multiSelect=0;jQuery(".card").remove();jQuery(".pack").remove();EventsManager.emptyElements();this.stockPack=new Deck(DECK_PACK);this.wastePack=new Deck(DECK_WASTE);this.aceDecks=[new Deck(DECK_ACE_HEART),new Deck(DECK_ACE_DIAMOND),new Deck(DECK_ACE_SPADE),new Deck(DECK_ACE_CLUB)];this.bottomDecks=[new Deck(DECK_BOTTOM,0),new Deck(DECK_BOTTOM,1),new Deck(DECK_BOTTOM,2),new Deck(DECK_BOTTOM,3),new Deck(DECK_BOTTOM,4),new Deck(DECK_BOTTOM,5),new Deck(DECK_BOTTOM,6)];var f=this.bottomDecks,e=this.aceDecks;this.stockPack.fillWith(d.pack);if(!this.stockPack.length){this.stackElt.addClass("empty")}this.wastePack.fillWith(d.wasteDeck).setPossibleSelections().showCards(this.wastePosX+(this.xSpace+10),this.wastePosY);this.setWasteShadow();e[0].fillWith(d.heartDeck).setPossibleSelections().showCards(this.acePosX,this.wastePosY);e[1].fillWith(d.diamondDeck).setPossibleSelections().showCards(this.acePosX+(this.aceSpace),this.wastePosY);e[3].fillWith(d.spadeDeck).setPossibleSelections().showCards(this.acePosX+(2*this.aceSpace),this.wastePosY);e[2].fillWith(d.clubDeck).setPossibleSelections().showCards(this.acePosX+(3*this.aceSpace),this.wastePosY);var c=f.length;for(var b=0;b<c;b++){f[b].fillWith(d.bottomDecks[b]).setPossibleSelections()}for(var b=0;b<c;b++){f[b].bindTopListeners(DECK_BOTTOM)}for(var b=0,a=e.length;b<a;b++){e[b].bindTopListeners(-1)}this.time=d.time;this.score=d.score;this.updateScore();this.runGame()},initGraphics:function(){var a=this;this.showCards();Console.log("[Graphics()] Here we go for some funky graphics stuff !");this.statusPanelElt.slideDown();this.optionsPanelElt.slideDown();this.stackElt.css({left:this.wastePosX+"px",top:this.wastePosY+"px"})},showCards:function(){var h=this.xSpace,e=this.xSpace+this.packCardSpace,g=this.mainDeckY,k=this.xStart,m=this.visibleCardSpace,a=this.hiddenCardSpace,n=this.bottomDecks;for(var f=0;f<RULES.length;f++){var l=n[f];var o=l.length;var d=0;for(var c=0;c<o;c++){var b=l.getCardAtPos(c);b.depth((f*MAX_CARDS)+c+2);b.setPosition(k+(f*e),g+d);if(b.isVisible()){d+=m;b.enableSelection(true)}else{d+=a}}}this.maxDepth=(RULES.length*MAX_CARDS)+c;this.setWasteShadow()},setupListeners:function(){var b=this,a=this.gameStats;jQuery("#statusPanel .startAgain").bind(EventsManager.EVENT_UP,jQuery.proxy(this.restart,this));jQuery(".restoreGame").live("click",function(){game.loadState();$.gritter.removeAll();return false});this.stackElt.bind(EventsManager.EVENT_UP,jQuery.proxy(this.nextPackCard,this));jQuery(window).bind("unload",function(){b.saveState();a.status=G_PAUSED;a.date=new Date().toUTCString();Console.log(a);Console.log(a.date);StateManager.setStatus(a)})},restart:function(){if(this.selectedCard!==null){this.toggleSelectedCard(this.selectedCard)}this.selectedCard=null;this.multiSelect=0;this.score=0;this.updateScore();jQuery(".card").remove();jQuery(".pack").remove();this.stackElt.removeClass("empty");this.setWasteShadow();EventsManager.emptyElements();this.shuffle();this.time.h=this.time.m=this.time.s=0;this.runGame()},runGame:function(){this.initGraphics();TimerManager.stop();TimerManager.start(this.time);this.gameStats.status=G_RUNNING},pauseGame:function(){this.gameStats.status=G_PAUSED},unpauseGame:function(){this.gameStats.status=G_RUNNING},updateTime:function(b){this.time=b;this.timeElt.html((b.m>9?b.m:("0"+b.m))+" : "+(b.s>9?b.s:("0"+b.s)));var a=this.aceDecks;if((a[0].length==13)&&(a[1].length==13)&&(a[2].length==13)&&(a[3].length==13)){this.endGameWon()}},flashScore:function(b){var a=this.scoreEvolElt;if(a.hasClass("shown")){a.removeClass("shown")}a.html((b>0?"+":"-")+b);setTimeout(function(){a.addClass("shown")},100)},updateScore:function(b,c){var a=this.scoreEvolElt;if(typeof b!=="undefined"){if(a.hasClass("shown")){a.removeClass("shown")}switch(b){case DECK_BOTTOM:if(c!==DECK_BOTTOM){this.score+=10;a.html("+ 10")}break;case DECK_WASTE:if(c===DECK_BOTTOM){this.score+=5;a.html("+ 5")}else{this.score+=10;a.html("+ 10")}break;default:this.score-=15;a.html("- 15");break}setTimeout(function(){a.addClass("shown")},100)}else{Console.log("decktype: oops :( !"+b)}this.scoreElt.html(this.score+" â‚¬")},clickKing:function(b,a){if(this.selectedCard===null||(a!==DECK_BOTTOM&&this.multiSelect===true)){return}if(a===DECK_BOTTOM){selectedDeck=this.bottomDecks[b]}else{selectedDeck=this.aceDecks[b]}if(selectedDeck.acceptCard(this.selectedCard)){SoundManager.playSound(SND_FLICK_CARD);this.toggleSelectedCard(this.selectedCard);this.swapDeck(this.selectedCard,selectedDeck);this.selectedCard=null}},toggleSelectedCard:function(a){if(a!==null){a.getDeck().toggleSelectionFromCard(a)}},clickCard:function(a){if(this.blockedSelection===true){return}var b=this.selectedCard;if(a!=null&&b!==a){if(this.touchMode===false&&b!==null){if(a.getDeck().acceptCard(b)){SoundManager.playSound(SND_FLICK_CARD);this.toggleSelectedCard(b);this.swapDeck(b,a.getDeck());a=null}else{a=b}}else{if(!a.isVisible()){this.score+=5;this.updateScore();a.setVisible(true);a=null;this.autoPlay()}else{if(this.touchMode===false){SoundManager.playSound(SND_CLICK_CARD);this.toggleSelectedCard(a);if(a.getDeck().getTop()===a){this.multiSelect=false}else{this.multiSelect=true}}}}if(this.touchMode===true&&a!==b&&a!==null){a.toggleStatus()}}else{if(this.touchMode===false){if(b){SoundManager.playSound(SND_CLICK_CARD);b.setStatus(ST_UNSELECTED)}a.getDeck().toggleSelectionFromCard(a);a=null}}if(this.touchMode===false){this.selectedCard=a}},swapDeck:function(b,e){this.blockedSelection=true;var g=b.getDeck(),a=0,f={},d=null;if(e.getTop()!==null){f=e.getTop().getPosition();a=this.visibleCardSpace}else{f=this.cardPos;a=0}if(g.isTop(b)!=true){d=g.popVisibleUpTo(b,false)}else{d=[g.pop()]}this.maxDepth++;if(e.getDeckType()!==DECK_BOTTOM){a=0}this.updateScore(g.getDeckType(),e.getDeckType());e.push(d);var j=this.visibleCardSpace,k=d.length,h=null;for(var c=0;c<k;c++){cardToMove=d[c];cardToMove.setPosition(f.x,f.y+a);cardToMove.depth(this.maxDepth++);cardToMove.saveOldPosition(f.x,f.y+a);a+=j}if(g.getTop()&&g.getTop().isVisible()===false&&this.gameOptions.autoFlip){g.reverseFirstInvisible();this.score+=5;this.updateScore()}g.setPossibleSelections();e.setPossibleSelections();if(b.getDeck().getDeckType()>6){setTimeout(jQuery.proxy(this.autoPlay,this),500)}else{if(b.getDeck().getDeckType()<6){setTimeout(function(){Particles.launchParticles(f)},300)}}this.blockedSelection=false},nextPackCard:function(){var e=0,f=this,c=this.wastePosX+this.xSpace+10,d=0,g=this.selectedCard;if(this.blockedPack===true){return}this.blockedPack=true;var a=this.stockPack.popMultiple(1);if(g!==null&&(g.getDeck()===this.wastePack)){this.toggleSelectedCard(g);this.selectedCard=g=null}if(a!==null){d=this.wastePack.getTop()?(this.wastePack.getTop().depth()+1):2;var l=a.length,k=this.visibleCardSpace,j=this.wastePosX,h=this.wastePosY;for(e=0;e<l;e++){var b=a[e];this.wastePack.push(b);b.setVisible(true);b.enableSelection(true);b.depth(d+e);b.setPosition(j,h,c+(e*k),h)}this.blockedSelection=true;setTimeout(function(){f.blockedSelection=false;f.autoPlay(true)},400)}else{this.stockPack.getCardsFromDeck(this.wastePack);this.stackElt.removeClass("empty");this.stockPack.setCardsVisibility(false)}if(this.stockPack.length===0){this.stackElt.addClass("empty")}this.setWasteShadow();this.blockedPack=false;return false},setWasteShadow:function(){var a=this.stockPack.length;if(a>=18){this.stackElt.removeClass("half").removeClass("less").addClass("full")}else{if(a>=6){this.stackElt.removeClass("full").removeClass("less").addClass("half")}else{this.stackElt.removeClass("half").removeClass("full").addClass("less")}}},autoPlay:function(e){if(!this.gameOptions.autoPlay){return}Console.log("autoPlay WORKING on IT");var f=false,d=this.wastePack.getTop(),c=this.bottomDecks.length,g=this.bottomDecks,b=0;Console.log("autoPlay "+e);if(e===undefined){Console.log("undefined");while(b<c){var a=g[b].getTop();if(a&&a.isVisible()){if(this.addToAce(a)){Console.log("matching ace !");f=true}else{if(a){Console.log(a.getColorNumber()+" does not match ")}}}b++}}if(d&&d.isVisible()){if(this.addToAce(d)){Console.log("matching ace (waste)");f=true}}if(f){setTimeout(jQuery.proxy(this.autoPlay,this),500)}Console.log("autoPlay return")},saveState:function(){var a=0;var b={pack:this.stockPack.getCardStates(),wasteDeck:this.wastePack.getCardStates(),heartDeck:this.aceDecks[0].getCardStates(),diamondDeck:this.aceDecks[1].getCardStates(),spadeDeck:this.aceDecks[3].getCardStates(),clubDeck:this.aceDecks[2].getCardStates(),bottomDecks:[],score:this.score,time:this.time},c=this.bottomDecks;for(a=0;a<MAX_CARDS;a++){b.bottomDecks.push(c[a].getCardStates());if(a<4&&CM.DEBUG){}}StateManager.saveState(b)},loadState:function(){StateManager.loadState(jQuery.proxy(this.resumeGame,this))},addToAce:function(b){var c=null,a=0;switch(b.getCardType()){case"spade":c=this.aceDecks[2];a=3;break;case"diamond":c=this.aceDecks[1];a=1;break;case"heart":c=this.aceDecks[0];a=0;break;case"club":c=this.aceDecks[3];a=2;break}if(c.acceptCard(b)){this.cardPos={x:this.acePosX+(a*this.aceSpace),y:this.wastePosY};this.swapDeck(b,c);this.toggleSelectedCard(this.selectedCard);this.selectedCard=null;SoundManager.playSound(SND_FLICK_CARD);return true}else{return false}},togglePauseGame:function(a){if(this.gameStats.status===G_PAUSED){TimerManager.start(this.time);this.gameStats.status=G_RUNNING}else{if(a){TimerManager.stop();this.gameStats.status=G_PAUSED}}},endGameWon:function(){this.gameStats.status=G_STOPPED;SoundManager.playSound(SND_YOU_WIN);TimerManager.stop();this.gameStats.gamesWon++;this.gameStats.scoreTotal+=this.score;alert("You made it ! (yeah, end game could and definitely *will* be improved ;))")}};